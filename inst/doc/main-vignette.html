<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Importing Data Generated by Freesurfer</title>

<script type="text/javascript">
window.onload = function() {
  var imgs = document.getElementsByTagName('img'), i, img;
  for (i = 0; i < imgs.length; i++) {
    img = imgs[i];
    // center an image if it is the only element of its parent
    if (img.parentElement.childElementCount === 1)
      img.parentElement.style.textAlign = 'center';
  }
};
</script>



<!-- MathJax scripts -->
<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 13px;
}

body {
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 20px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 {
   font-size:2.2em;
}

h2 {
   font-size:1.8em;
}

h3 {
   font-size:1.4em;
}

h4 {
   font-size:1.0em;
}

h5 {
   font-size:0.9em;
}

h6 {
   font-size:0.8em;
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre, img {
  max-width: 100%;
}
pre {
  overflow-x: auto;
}
pre code {
   display: block; padding: 0.5em;
}

code {
  font-size: 92%;
  border: 1px solid #ccc;
}

code[class] {
  background-color: #F8F8F8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thin;
   border-top-style: dotted;
   border-top-color: #999999;
}

@media print {
   * {
      background: transparent !important;
      color: black !important;
      filter:none !important;
      -ms-filter: none !important;
   }

   body {
      font-size:12pt;
      max-width:100%;
   }

   a, a:visited {
      text-decoration: underline;
   }

   hr {
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote {
      padding-right: 1em;
      page-break-inside: avoid;
   }

   tr, img {
      page-break-inside: avoid;
   }

   img {
      max-width: 100% !important;
   }

   @page :left {
      margin: 15mm 20mm 15mm 10mm;
   }

   @page :right {
      margin: 15mm 10mm 15mm 20mm;
   }

   p, h2, h3 {
      orphans: 3; widows: 3;
   }

   h2, h3 {
      page-break-after: avoid;
   }
}
</style>



</head>

<body>
<p>The rsurfer package contains functions to aid the importing and manipulation of data generated by the software suite, &#39;Freesurfer&#39;. &#39;Freesurfer&#39; is an open-source software suite involving the segmentation of brain MRIs (see <a href="http://freesurfer.net/">http://freesurfer.net/</a> for more information). This package provides functionality to import the data generated by &#39;Freesurfer&#39;, specifically the data generated by the cortical restruction function of &#39;Freesurfer&#39; (recon-all). Once this data is imported, rsurfer provides functions to easily manipulate the data; and also provides brain specific normalisation commonly used when studying structural brain MRIs (a number of intra-cranial volume normalisation methods are provided). This package has been designed using an installation of and data generated from &#39;Freesurfer&#39; version 5.3 - it may function with older/newer versions but it is untested.</p>

<p>If you would like to request features then please look at the rsurfer repository on GitHub (see <a href="https://github.com/AlexDiru/rsurfer">https://github.com/AlexDiru/rsurfer</a>), in particular the Issues tab, where bug reports and feature requests can be made. Additionally if you would like to write the functionality yourself and merge it with rsurfer, please email me at: <a href="mailto:alexspedding271@gmail.com">alexspedding271@gmail.com</a>.</p>

<h1>Importing Data Generated by Freesurfer</h1>

<h2>Download MRI Data</h2>

<p>You need to download the MRI scans you want to analyse, for example MRI scans from the Alzheimer&#39;s Disease Neuroimaging Initiative (ADNI; see: <a href="http://adni.loni.usc.edu/">http://adni.loni.usc.edu/</a>).</p>

<h2>Process the MRI Data With Freesurfer</h2>

<p>With Freesurfer version 5.3, the data can be processed using the the command (adjusting the file locations and ID as to what corresponds with your data): </p>

<p>recon-all -i /input_data/MRI_IMAGE.nii.gz -sd /output_data/ -subjid SUBJECT_ID -all -hippo-subfields</p>

<p>This will then create a subfolder in &ldquo;output_data&rdquo; ready to be imported with rsurfer. For more information regarding this step, please use the Freesurfer website: <a href="http://freesurfer.net/">http://freesurfer.net/</a></p>

<h2>Import with rsurfer</h2>

<p>Now that the data has been generated we can begin to use R and rsurfer. If you do not have any MRI data to import please skip this step.</p>

<p>First install rsurfer if you have not done so already: <code>library(rsurfer)</code></p>

<p>Then there are two lines of code which will import the data:</p>

<pre><code>setfshome(&quot;/Applications/freesurfer&quot;)
mri_data &lt;- fsimport(&quot;/output_data/&quot;)
</code></pre>

<p>The first line uses the function <code>setfshome</code> which points rsurfer to your Freesurfer installation. My Freesurfer installation is installed in &ldquo;/Applications/freesurfer&rdquo; so you would need to replace this with where Freesurfer is located on your system. The second line uses the function <code>fsimport</code> which given an input directory it will import all of the subdirectories in this directory into a dataframe and returns the data frame from the function, it will treat every subdirectory as a subject, so it will likely fail if you have subdirectories which are not generated as a result of Freesurfer&#39;s cortical reconstruction command.</p>

<p>If you are importing a large number of processed subjects into R it may take some time to run fsimport. Handily rsurfer has a in-built function which will run fsimport and then serialise the output to a file. When this function is run again, it will see the existence of the serialised file and just load that.</p>

<pre><code>setfshome(&quot;/Applications/freesurfer&quot;)
mri_data &lt;- fsimport.serialise(&quot;/output_data/&quot;, &quot;serialised.rds&quot;)
</code></pre>

<p>The second line uses the function <code>fsimport.serialise</code>, similar to <code>fsimport</code> this points to the output directory of subjects to import. The second parameter refers to the file where the serialised data will be stored. If the serialised file exists then the function will deserialise the data and return that, otherwise it will call the <code>fsimport</code> function and once that is complete it will then serialise the data.</p>

<p>I found that when importing my generated data, some of the rows and columns of the data table are what I would call abnormal (such as missing values or columns where all values are zero). There is a function provided to clean up the imported data.</p>

<pre><code>mri_data &lt;- eliminateabnormalities(mri_data, verbose = T) 
</code></pre>

<p>The verbose flag is set to true so you will be aware of which rows and columns are removed in case you want to investigate further.</p>

<h2>Generating Random Data With rsurfer</h2>

<p>If you have your own MRI data to use, you can skip this step. Otherwise, if you do not have any data to use with rsurfer, you can generate random data that is structured as if it was generated by &#39;Freesurfer&#39; (note that all the fields have random values but the columns are what is expected as a result from <code>fsimport</code>).</p>

<pre><code>mri_data &lt;- generaterandomsubjects() 
</code></pre>

<p>This function will generate 40 subjects, but you can input a number of subjects to generate as an input parameter, for example: <code>generaterandomsubjects(100)</code> will generate 100 subjects.</p>

<h1>Manipulating Data Generated by Freesurfer</h1>

<p>If you are importing real MRI data generated from Freesurfer, your code should look similar to:</p>

<pre><code>setfshome(&quot;/Applications/freesurfer&quot;)
mri_data &lt;- fsimport.serialise(&quot;/output_data/&quot;, &quot;serialised.rds&quot;)
</code></pre>

<p>And if you are generating random data, it will look similar to:</p>

<pre><code>mri_data &lt;- generaterandomsubjects() 
</code></pre>

<h2>Error Checking</h2>

<p>If the Freesurfer data fails to import then potentially something has gone wrong in the Freesurfer processing step. rsurfer provides a function which checks for any missing files which may the import function to fail. The function require the filepath of the subjects&#39; directory and will check every subfolder there thus it can perform error checking on every subject in one call.</p>

<pre><code>fsdirectorycheck(&quot;/output_data/&quot;)
</code></pre>

<h2>Extracting Groups of Features</h2>

<p>This section will discuss functions you can use to extract groups of features of the data.</p>

<pre><code>extract.brain.features(mri_data) # Extracts all measurements generated by Freesurfer (this is useful when the data has been augmented with other features)

extract.volumes(mri_data) # Extracts all volumetric measurements generated by Freesurfer

extract.hippocampalvolumes(mri_data) # Extracts all the hippocampal volumes generated with the -hippo-subfields flag

extract.cortical(mri_data) # Extracts all the cortical measurements (areas, volumes, thicknesses and standard deviations of thicknesses) from the data

extract.corticalvolumes(mri_data) # Extracts all the cortical volume measurements

extract.corticalsurfaceareas(mri_data) # Extracts all the cortical surface area measurements

extract.corticalthicknesses(mri_data) # Extracts all the cortical thicknesses

extract.corticalthicknessstddevs(mri_data) # Extracts all the standard deviations of the cortical thicknesses

extract.subcorticalvolumes(mri_data) # Extracts all the subcortical volumes generated by Freesurfer
</code></pre>

<p>All of the above functions, allow a second parameter to be passed which is a vector of strings determining any additional features to keep. For example if we were to add an age and gender feature to our data:</p>

<pre><code>mri_data$Age &lt;- runif(nrow(mri_data), 50, 80)
mri_data &lt;- addrandomgender(mri_data)
</code></pre>

<p>They could then be extracted in the output of one of the above functions like:</p>

<pre><code>extract.corticalthicknesses(mri_data, c(&quot;Age&quot;, &quot;Gender&quot;))
</code></pre>

<p>If you wanted to write a loop which would iterate through the above sets of fields, you can use the <code>extract.byname</code> function, which will take as input the MRI data and a string specifying which field set to return, so you could write something like the below:</p>

<pre><code>for (fieldGroup in c(&quot;corticalvolumes&quot;, &quot;subcortical&quot;, &quot;hippocampal&quot;, &quot;corticalareas&quot;, &quot;corticalthicknesses&quot;, &quot;corticalthicknessstds&quot;)) {
    extract.byname(mri_data, fieldGroup)
}
</code></pre>

<h2>Discovering Information About a Feature</h2>

<p>rsurfer provides methods to discover information about a specific feature:</p>

<pre><code>feature &lt;- &quot;lh.bankssts.area&quot;

get.hemisphere.side(feature) # Gets the hemisphere of the brain a feature belongs to (left or right), if it is neither of those then central is returned

getfieldgroup(feature) # Given a feature name this function will return some information as to what type the measurement is

getfieldgroup(feature, 2) # A second parameter can be input, determining how specific the returned information is. The default value of 1 is the most specific the returned information can be; the value of 2 is the least specific it can be.

get.opposite.hemisphere.measurement(feature) # Given a left hemisphere measurement, will return the corresponding right hemisphere; and vice-versa
</code></pre>

<h1>Intracranial Volume Normalisation</h1>

<p>rsurfer provides method to implement a variety of intracranial volume (ICV) normalisation techniques. Note that if any of these ICV normalisation methods produce an error saying that &#39;Gender must be a factor&#39; then you can just insert the line of code: <code>mri_data$Gender &lt;- as.factor(mri_data$Gender)</code></p>

<h2>Proportional Intracranial Volume Normalisation</h2>

<p>This is the most commonly used method, and is the easiest to implement. the aim is to express a volume as the proportion of the brain it occupies and it is computed by:</p>

<p>\[v' = \frac{v}{ICV}\]</p>

<p>Where \(v\) is the unnormalised volume of the patient, \({ICV}\) is the intra cranial volume of the patient and \(v'\) is the normalised volume of the patient. This method is completely independent of any other subjects.</p>

<pre><code>normalise(mri_data, &quot;normalisation.proportional&quot;)
</code></pre>

<h2>Residual Intracranial Volume Normalisation</h2>

<p>The residual method assumes a linear relation between the volumes and the subject&#39;s ICV and estimates the relationship such that: \({v' = v - w_1(ICV - \overline{ICV})}\) where \({\overline{ICV}}\) is the average intra cranial volume across all subjects being considered, and \({w_1}\) is a coefficient computed by solving the linear regression problem of \({v' = w_1ICV + w_0}\). </p>

<pre><code>normalise(mri_data, &quot;normalisation.residual&quot;)
</code></pre>

<p>The residual method can be further refined by assuming a different relationship between male and female subjects&#39; volumes and their ICVs such that if the subject is male: \({v_{MALE}&lsquo; = v - w_{1,MALE}(ICV-\overline{ICV_{MALE}})}\) where \({w_{1,MALE}}\) is found by solving the linear regression problem of \({v&rsquo; = w_{1,MALE}ICV + w_{0,MALE}}\) where only male subjects are considered. And a similar problem for female patients where in the above example, males are replaced by females: \({v_{FEMALE}&lsquo; = v - w_{1,FEMALE}(ICV-\overline{ICV_{FEMALE}})}\) where \({w_{1,FEMALE}}\) is found by solving the linear regression problem of \({v&rsquo; = w_{1,FEMALE}ICV + w_{0,FEMALE}}\) only considering female subjects.</p>

<pre><code>normalise(mri_data, &quot;normalisation.residualgender&quot;)
</code></pre>

<h2>Covariate Intracranial Volume Normalisation</h2>

<p>The covariate method \cite{Nordenskjold2013355} is similar to the residual method but it considers gender at the linear relationship level such that gender is another variable in the linear regression. The normalised volume is computed via \({v' = v - w_1(ICV - \overline{ICV}) + w_2(Gender - \overline{Gender})}\) where \({w_1}\) and \({w_2}\) are found by solving the linear regression problem: \({v' = w_0 + w_1ICV + w_2Gender}\).</p>

<pre><code>normalise(mri_data, &quot;normalisation.covariate&quot;)
</code></pre>

<h2>Power Proportional Intracranial Volume Normalisation</h2>

<p>The power proportion method \cite{liu2014power} computes the normalised volume as \({v'=\frac{v}{ICV^{w_1}}}\) where \({w_1}\) is computed by the power regression problem: \({v'=w_0ICV^{w_1}}\). Note that this power regression problem can be converted to a linear regression problem by taking the natural logarithm of both sides to create \({\ln(v') = w_1\ln(ICV)+\ln(w_0)}\).</p>

<pre><code>normalise(mri_data, &quot;normalisation.powerproportion&quot;)
</code></pre>

<h1>Alzheimer&#39;s Disease Neuroimaging Initiative Data</h1>

<p>The Alzheimer&#39;s Disease Neuroimaging Initiative (ADNI) is a database which collects various data (including structural MRIs) to be used in the prediction of Alzheimer&#39;s Disease. The structural MRIs belong to patients who are healthy or diagnosed with mild cognitive impairment or Alzheimer&#39;s disease. The structural MRIs can be processed with Freesurfer however the output data does not contain any information about the subject such as their age, gender or what they were diagnosed with. ADNI provides this data in two CSV files: ADNIMERGE.csv and DXSUM_ PDXCONV_ ADNIALL.csv. And requires you to extract various data from the files. rsurfer automates this process for baseline scans:</p>

<pre><code>adni.setfiles(&quot;DXSUM_PDXCONV_ADNIALL.csv&quot;, &quot;ADNIMERGE.csv&quot;) # Point rsurfer to the files
mri_data &lt;- adni.mergewithfreesurferoutput(mri_data) # Merges data assuming unchanged subject IDs (the row names)
</code></pre>

<h1>Information Extraction from Images Data</h1>

<p>Information Extraction from Images (IXI) is a database which collects structural MRIs of healthy subjects from a wide age range. Similar to the ADNI functionality, rsurfer provides methods to merge the subject&#39;s age and gender with their structural MRI data.</p>

<pre><code>ixi.setfile(&quot;IXI.csv&quot;) # Point rsurfer to the IXI file
mri_data &lt;- ixi.mergewithfreesurferoutput(mri_data) # Merges data assuming unchanged subject IDs (the row names)
</code></pre>

<h1>CAD Dementia Data</h1>

<p>The CAD Dementia challenge provides a set of structural MRIs, like ADNI and IXI, rsurfer provides functionality to merge subject information with the imported data for both the training and test data.</p>

<pre><code>caddementia.setfiles(&quot;train.txt&quot;,&quot;test.txt&quot;)
mri_data &lt;- caddementia.mergewithfreesurferoutput(mri_data)
</code></pre>

</body>

</html>
